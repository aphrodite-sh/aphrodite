<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Quickstart - Aphrodite</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/tufte.css">
<link rel="stylesheet" href="/main.css">
<link rel="stylesheet" href="/docs/index.css">

<meta name="description" content="Aphrodite makes it easy to describe, model and interact with your data. If you&#x27;d like to understand why this project exists before diving in, see Why Aphrodite? If you learn faster by looking at code, we have a starter repositories you can clone and get…">
<meta name="keywords" content="software, schemas, data">
<meta name="author" content="Matt Wonlaw">
<meta name="copyright" content="© 2022 Matt Wonlaw">
<meta property="og:type" content="article">
<meta property="og:site_name" content="Aphrodite">
<meta property="og:title" content="Quickstart">
<meta property="og:description" content="Aphrodite makes it easy to describe, model and interact with your data. If you&#x27;d like to understand why this project exists before diving in, see Why Aphrodite? If you learn faster by looking at code, we have a starter repositories you can clone and get…">
<meta property="og:image" content="https://aphrodite.sh/assets/gods/zeus.png">
<meta property="og:image:alt" content="Zeus">
<meta property="og:image:width" content="266">
<meta property="og:image:height" content="200">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://aphrodite.sh/assets/gods/zeus.png">
<meta name="twitter:image:alt" content="Zeus">
<meta name="twitter:site" content="@tantaman">
<meta name="twitter:label1" content="Reading time">
<meta name="twitter:data1" content="7-11 minutes">
</head>
<body><a href="https://github.com/tantaman/aphrodite" class="github-corner" aria-label="View source on GitHub"><svg width="100" height="100" viewBox="0 0 250 250" style="fill:var(--dress); color:var(--black); position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><aside><div class="center"><a class="home-link" href="/"><div class="god-circle center-block"><div class="god-head god-head-aphrodite"></div></div></a><a class="hamburger"></a></div><ol><li class="indent"><a href="/docs/why">Why Aphrodite</a></li><li class="active indent"><a href="/docs/quickstart">Quickstart</a></li><li class="indent"><a href="/docs/schemas">Schemas</a></li><li class="indent"><a href="/docs/models">Models</a></li><li class="indent"><a href="/docs/mutations-and-transactions">Mutating Data</a></li><li class="indent"><a href="/docs/queries">Queries</a></li><li class="indent"><a href="/docs/reactivity">Reactivity</a></li><li class="indent"><a href="/docs/data-sync-p2p">Data Sync &#x26; P2P</a></li><li class="indent"><a href="/docs/permissions">Permissions</a></li><li class="indent"><a href="/docs/migrations">Migrations</a></li></ol></aside><main><article><h1>Quickstart</h1><p class="subtitle">get up and running with Aphrodite</p><section>
<nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#starter-repositories">Starter Repositories</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#setup">Setup</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#installation">Installation</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#configuration">Configuration</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#db-connection">DB Connection</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#your-first-schema">Your First Schema</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#bootstrapping--table-creation">Bootstrapping / Table Creation</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#compile--run">Compile &#x26; Run</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#querying-for-nodes">Querying for Nodes</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#adding-a-mutation">Adding a Mutation</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#creating--mutating-a-node">Creating / Mutating a Node</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#defining-an-edge">Defining an Edge</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#walking-a-graph">Walking a Graph</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#reactive-queries">Reactive Queries</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#react-integration">React Integration</a></li></ol></nav><p><code>Aphrodite</code> makes it easy to describe, model and interact with your data. If you'd like to understand <em>why</em> this project exists before diving in, see <a class="internal new" href="/docs/why">Why Aphrodite?</a></p>
<h1 id="starter-repositories"><a aria-hidden="true" tabindex="-1" href="#starter-repositories"><span class="icon icon-link"></span></a>Starter Repositories</h1>
<p>If you learn faster by looking at code, we have a <strong>starter repositories</strong> you can clone and get running with. The starter projects also take care of most of the boilerplate in this guide.</p>
<ul>
<li><a href="https://github.com/tantaman/aphrodite-node-starter">Node JS Starter</a></li>
<li>Browser Starter (all data stored locally in the browser) (WIP but see the <a href="https://github.com/tantaman/aphrodite/blob/main/examples/todo-mvc/">TodoMVC example</a>)</li>
<li>Deno Starter (WIP)</li>
<li><a href="https://github.com/tantaman/aphrodite-graphql-starter">GraphQL Server Starter</a> (WIP)</li>
<li>iOS Starter (WIP)</li>
<li>Android Starter (WIP)</li>
</ul>
<blockquote>
<p>Why server components if you're local-first? For improved durability and availability for those that want it.</p>
</blockquote>
<h1 id="setup"><a aria-hidden="true" tabindex="-1" href="#setup"><span class="icon icon-link"></span></a>Setup</h1>
<p>We'll assume you did not clone any of the starter projects above. If you did, you can use those and skip the steps that are already completed.</p>
<p>Create a directory for the quickstart project and cd into it. This is where we'll put our source and install our dependencies.</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">mkdir</span> quickstart
<span class="hljs-built_in">cd</span> quickstart
</code></pre>
<h1 id="installation"><a aria-hidden="true" tabindex="-1" href="#installation"><span class="icon icon-link"></span></a>Installation</h1>
<p><code>Aphrodite</code> has two main components:</p>
<ol>
<li>The runtime for the given target</li>
<li>The codegen framework</li>
</ol>
<p>These are shipped as two separated packages as the codegen framework is only needed during development and is not deployed with your application.</p>
<p>Install them using <a href="https://www.npmjs.com/">npm</a> as seen below --</p>
<pre><code class="hljs language-bash">npm install --save @aphro/runtime-ts
npm install --save-dev @aphro/codegen-cli
</code></pre>
<h1 id="configuration"><a aria-hidden="true" tabindex="-1" href="#configuration"><span class="icon icon-link"></span></a>Configuration</h1>
<p>Given <code>Aphrodite</code> will be talking to a database, it needs some information about the database in order to be able to connect. This information is saved in the <code>Context</code> type.</p>
<p>create a <code>main.ts</code> file.</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">mkdir</span> src
<span class="hljs-built_in">touch</span> src/main.js
</code></pre>
<p>and add the following to it</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">import</span> { context, anonymous, basicResolver } <span class="hljs-keyword">from</span> <span class="hljs-string">'@aphro/runtime-ts'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">context</span>(<span class="hljs-title function_">anonymous</span>(), <span class="hljs-title function_">basicResolver</span>(db));
}

<span class="hljs-keyword">await</span> <span class="hljs-title function_">main</span>();
</code></pre>
<p>So what's going on here?</p>
<ul>
<li><code>Anonymous</code> declares that the logged in viewer is anonymous. In the future <code>Aphrodite</code> will allow you to express permission rules which take in the current viewer. Given this is not yet implemented (see <a class="internal new" href="/blog/roadmap">blog/roadmap</a>), you'll need to handle permissions elsewhere and pass an anonymous viewer to <code>Aphrodite</code>.</li>
<li><code>basicResolver</code> is a function that returns a connection to the database. Note that we're currently passing an undefined variable <code>db</code> here -- we'll get to setting that up in the next section.</li>
<li>Both parameters are passed into the <code>context</code> function which returns a new <code>context</code> for use when interacting with <code>Aphrodite</code>.</li>
</ul>
<h1 id="db-connection"><a aria-hidden="true" tabindex="-1" href="#db-connection"><span class="icon icon-link"></span></a>DB Connection</h1>
<p>Ok. Now lets get the <code>db</code> variable defined.</p>
<p>Getting a connection to the db differs by environment. For <code>Node</code>, the simplest route is to use <code>@databases/sqlite</code>. For the browser, use <code>@aphro/absurd-sql-connector</code>.</p>
<p>Lets concern ourself with <code>Node</code> for now after which you'll understand all the concepts needed to do the same thing in the browser.</p>
<p>Install the connection provider. In this cases <code>@databases/sqlite</code></p>
<pre><code class="hljs language-bash">npm install --save @databases/sqlite
</code></pre>
<p>Now import it and use it to create a connection to the DB.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">import</span> { context, anonymous, basicResolver } <span class="hljs-keyword">from</span> <span class="hljs-string">'@aphro/runtime-ts'</span>;
<span class="hljs-keyword">import</span> connect <span class="hljs-keyword">from</span> <span class="hljs-string">"@databases/sqlite"</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> db = <span class="hljs-title function_">connect</span>(<span class="hljs-string">"test.db"</span>);
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">context</span>(<span class="hljs-title function_">anonymous</span>(), <span class="hljs-title function_">basicResolver</span>(db));
}
</code></pre>
<p>"test.db" will be the file that holes our database. If the file does not exist it will be created. If you do not pass a file name your data will be stored in memory.</p>
<h1 id="your-first-schema"><a aria-hidden="true" tabindex="-1" href="#your-first-schema"><span class="icon icon-link"></span></a>Your First Schema</h1>
<p>Schemas are the foundation of <code>Aphrodite</code>. They are stored as code and describe your application's data model. From the information provided in the schema, we go on to generate:</p>
<ol>
<li>The corresponding database schema</li>
<li>Classes to represent your data in the target language</li>
<li>Query builders to traverse your data</li>
<li>Mutators to safely modify your data</li>
</ol>
<p>To get started, create a file in your project's <code>src</code> directory called <code>domain.aphro</code>. This is where we'll place our node and edge definitions.</p>
<p>Open that file and define a <code>TodoList</code> node --</p>
<pre><code class="hljs language-typescript"><span class="hljs-attr">engine</span>: sqlite

<span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Node</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span>&#x3C;<span class="hljs-title class_">TodoList</span>>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
}
</code></pre>
<p>next run</p>
<pre><code class="hljs language-bash">npx aphro gen src/domain.aphro -d src/generated
</code></pre>
<blockquote>
<p>Pro-tip: you can add this command to the <code>package.json</code> scripts entry so you don't have to remember it.</p>
</blockquote>
<p>This will generate a few files:</p>
<pre><code class="hljs language-bash">src/generated
|-- TodoList.sqlite.sql
|-- TodoList.ts
|-- TodoListQuery.ts
|-- TodoListSpec.ts
</code></pre>
<h1 id="bootstrapping--table-creation"><a aria-hidden="true" tabindex="-1" href="#bootstrapping--table-creation"><span class="icon icon-link"></span></a>Bootstrapping / Table Creation</h1>
<p>All the schemas are generated but we haven't actually set up our database or created the tables! Lets go ahead and do that.
The codegen step created a <code>TodoList.sqlite.sql</code> file that we can use to create the TodoList table.</p>
<p>You have a few options here:</p>
<ol>
<li>Manually run that against your <code>sqlite</code> db</li>
<li>Run it within your <code>main.ts</code> file</li>
</ol>
<p>We'll assume you're going to do (2).</p>
<p>Create a <code>createTables</code> function in <code>main.ts</code></p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'url'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DatabaseConnection</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@databases/sqlite"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> { readdirSync } <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>;
<span class="hljs-keyword">const</span> __filename = <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>);
<span class="hljs-keyword">const</span> __dirname = path.<span class="hljs-title function_">dirname</span>(__filename);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createTables</span>(<span class="hljs-params">db: DatabaseConnection</span>) {
  <span class="hljs-keyword">const</span> generatedDir = path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">".."</span>, <span class="hljs-string">"src"</span>, <span class="hljs-string">"generated"</span>);
  <span class="hljs-keyword">const</span> schemaPaths = <span class="hljs-title function_">readdirSync</span>(generatedDir).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">name</span> =></span> name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.sqlite.sql'</span>));

  <span class="hljs-keyword">const</span> schemas = schemaPaths.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =></span> sql.<span class="hljs-title function_">file</span>(path.<span class="hljs-title function_">join</span>(generatedDir, s)));

  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(schemas.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =></span> db.<span class="hljs-title function_">query</span>(s)));
}
</code></pre>
<p>(TODO: create tables bootstrapping needs to be simplified)</p>
<p>and then call it from your <code>main</code> function --</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> db = <span class="hljs-title function_">connect</span>(<span class="hljs-string">"test.db"</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">createTables</span>(db); <span class="hljs-comment">// new call to `createTables`</span>
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">context</span>(<span class="hljs-title function_">anonymous</span>(), <span class="hljs-title function_">basicResolver</span>(db));
}
</code></pre>
<p>Great! We should be good to go to compile and run our script.</p>
<h1 id="compile--run"><a aria-hidden="true" tabindex="-1" href="#compile--run"><span class="icon icon-link"></span></a>Compile &#x26; Run</h1>
<p>Compiling and running requires setting up the typescript compiler. Lets go ahead and do that</p>
<p>first, install typescript as a dependency</p>
<pre><code class="hljs language-bash">npm install --save-dev typescript
</code></pre>
<p>next, add a <code>tsconfig.json</code> to your project</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esnext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esnext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sourceMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>third, add <code>build</code> and <code>watch</code> scripts to your <code>package.json</code></p>
<pre><code class="hljs language-json">...
<span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"watch"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc -w"</span>
<span class="hljs-punctuation">}</span>
...
</code></pre>
<p>finally, we can run our build. Run it in watch mode so any time a ts file changes there will be a rebuild.</p>
<pre><code class="hljs language-bash">npm run watch
</code></pre>
<p>And now, in another terminal, lets run our program:</p>
<pre><code class="hljs language-bash">node dist/main.js
</code></pre>
<p>You should see that "test.db" was created in your project root. If you want to inspect this file you can use <a href="https://sqlitebrowser.org/">SQLite Browser</a> or install <a href="https://marketplace.visualstudio.com/items?itemName=alexcvzz.vscode-sqlite">vscode-sqlite</a>.</p>
<h1 id="querying-for-nodes"><a aria-hidden="true" tabindex="-1" href="#querying-for-nodes"><span class="icon icon-link"></span></a>Querying for Nodes</h1>
<p>If you take a look at the generated <code>TodoList</code> model (<code>TodoList.ts</code>) you'll see that it provides a number of methods for fetching and querying <code>TodoLists</code>.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">queryAll</span>(<span class="hljs-attr">ctx</span>: <span class="hljs-title class_">Context</span>): <span class="hljs-title class_">TodoListQuery</span>;

<span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">genx</span>(
  <span class="hljs-attr">ctx</span>: <span class="hljs-title class_">Context</span>,
  <span class="hljs-attr">id</span>: SID_of&#x3C;<span class="hljs-title class_">TodoList</span>>
): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">TodoList</span>>;

<span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">gen</span>(
  <span class="hljs-attr">ctx</span>: <span class="hljs-title class_">Context</span>,
  <span class="hljs-attr">id</span>: SID_of&#x3C;<span class="hljs-title class_">TodoList</span>>
): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">TodoList</span> | <span class="hljs-literal">null</span>>;
</code></pre>
<p>We'll use these to query for <code>TodoLists</code>. Lets update our main function.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./generated/TodoList.js"</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> db = <span class="hljs-title function_">connect</span>(<span class="hljs-variable constant_">DB_FILE</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">createTables</span>(db); <span class="hljs-comment">// new call to `createTables`</span>
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">context</span>(<span class="hljs-title function_">anonymous</span>(), <span class="hljs-title function_">basicResolver</span>(db));

  <span class="hljs-comment">// Query our todo lists -- none exist yet so we should get back an empty list</span>
  <span class="hljs-keyword">const</span> lists = <span class="hljs-keyword">await</span> <span class="hljs-title class_">TodoList</span>.<span class="hljs-title function_">queryAll</span>(ctx).<span class="hljs-title function_">gen</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lists);
}
</code></pre>
<p>We haven'te created any todolists yet so the output of our program is just <code>[]</code>. Lets move on to creating some data.</p>
<h1 id="adding-a-mutation"><a aria-hidden="true" tabindex="-1" href="#adding-a-mutation"><span class="icon icon-link"></span></a>Adding a Mutation</h1>
<p>We have classes that allow us to load and query <code>TodoList</code>. What's missing, however, is the ability to create a <code>TodoList</code>. This is because we haven't defined any mutations yet. Mutation are defined on our schemas. Declaring mutations in the schema is a powerful feature -- it lets us auto-generate things like <code>GraphQL</code> mutations, declare permissions for mutations, and turn our data access layer into a protocol (for cool things like integration into <a href="https://blockprotocol.org/">block protocol</a>).</p>
<p>Open <code>domain.aphro</code> and add the following:</p>
<pre><code class="hljs language-typescript"><span class="hljs-attr">engine</span>: sqlite

<span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Node</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span>&#x3C;<span class="hljs-title class_">TodoList</span>>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
} &#x26; <span class="hljs-title class_">Mutations</span> {
  create <span class="hljs-keyword">as</span> <span class="hljs-title class_">Create</span> {
    name
  }
}
</code></pre>
<p>then re-run the codegen</p>
<pre><code class="hljs language-bash">npx aphro gen src/domain.aphro -d src/generated
</code></pre>
<p>You'll now see two new files -- <code>TodoListMutations.ts</code> and <code>TodoListMutationsImpl.ts</code>. We'll use these to create some data.</p>
<ul>
<li><code>TodoListMutations.ts</code> is completely genenreated and exposes the mutation API.</li>
<li><code>TodoListMutationsImpl.ts</code> is where you enter your implementation of the API.</li>
</ul>
<h1 id="creating--mutating-a-node"><a aria-hidden="true" tabindex="-1" href="#creating--mutating-a-node"><span class="icon icon-link"></span></a>Creating / Mutating a Node</h1>
<p>Opening up <code>TodoListMutationsImpl.ts</code> you'll see this method that has been generated for you:</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createImpl</span>(<span class="hljs-params">
  mutator: Omit&#x3C;IMutationBuilder&#x3C;TodoList, Data>, <span class="hljs-string">"toChangeset"</span>>,
  { name }: CreateArgs
</span>): <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Changeset</span>&#x3C;<span class="hljs-built_in">any</span>>[] {
  <span class="hljs-comment">// Use the provided mutator to make your desired changes.</span>
  <span class="hljs-comment">// e.g., mutator.set({name: "Foo" });</span>
  <span class="hljs-comment">// You do not need to return anything from this method. The mutator will track your changes.</span>
  <span class="hljs-comment">// If you do return changesets, those changesets will be applied in addition to the changes made to the mutator.</span>
}
</code></pre>
<p>Here you can fill in any logic that should take place upon creation. <code>TodoList</code> is pretty simple -- we'll only be setting the name and id on create. Inside the <code>create</code> method we can access the raw <code>mutator</code> which lets us change any property on the model.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { sid } <span class="hljs-keyword">from</span> <span class="hljs-string">"@aphro/runtime-ts"</span>; <span class="hljs-comment">// new import to generate ids</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createImpl</span>(<span class="hljs-params">
  mutator: Omit&#x3C;IMutationBuilder&#x3C;TodoList, Data>, <span class="hljs-string">'toChangeset'</span>>,
  { name }: CreateArgs,
</span>): <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Changeset</span>&#x3C;<span class="hljs-built_in">any</span>>[] {
  mutator.<span class="hljs-title function_">set</span>({
    <span class="hljs-attr">id</span>: <span class="hljs-title function_">sid</span>(<span class="hljs-string">"aaaa"</span>), <span class="hljs-comment">// we'll get into id generation later but just use this for now.</span>
    name
  });
}
</code></pre>
<p>Now that the create mutation has been implemented, lets go ahead and use it.</p>
<p>Update <code>src/main.ts</code> --</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoListMutations</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./generated/TodoListMutations.js"</span>; <span class="hljs-comment">// new import</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> db = <span class="hljs-title function_">connect</span>(<span class="hljs-string">"test.db"</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">createTables</span>(db);
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">context</span>(<span class="hljs-title function_">anonymous</span>(), <span class="hljs-title function_">basicResolver</span>(db));

  <span class="hljs-comment">// Check for existing lists</span>
  <span class="hljs-keyword">let</span> lists = <span class="hljs-keyword">await</span> <span class="hljs-title class_">TodoList</span>.<span class="hljs-title function_">queryAll</span>(ctx).<span class="hljs-title function_">gen</span>();
  <span class="hljs-comment">// If there are none, create one</span>
  <span class="hljs-keyword">if</span> (lists.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">let</span> writeHandle;
    [writeHandle, todoList] = <span class="hljs-title class_">TodoListMutations</span>.<span class="hljs-title function_">create</span>(ctx, {
      <span class="hljs-attr">name</span>: <span class="hljs-string">"My first list!"</span>,
    }).<span class="hljs-title function_">save</span>();

    <span class="hljs-comment">// Wait for our write to persist</span>
    <span class="hljs-keyword">await</span> writeHandle;
    lists = <span class="hljs-keyword">await</span> <span class="hljs-title class_">TodoList</span>.<span class="hljs-title function_">queryAll</span>(ctx).<span class="hljs-title function_">gen</span>();
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lists);
}
</code></pre>
<p>Save returns two things:</p>
<ol>
<li>A promise to the pending database write</li>
<li>An optimistic update, representing the created model before the DB write has completed</li>
</ol>
<p>The optimsitc update is useful for highly interactive environments where you want to do something with the changes before the write actually completes.</p>
<p>The above code is a little cumbersome if we only want to create a single list. Lets clean it up.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> db = <span class="hljs-title function_">connect</span>(<span class="hljs-string">"test.db"</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">createTables</span>(db);
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-title function_">context</span>(<span class="hljs-title function_">anonymous</span>(), <span class="hljs-title function_">basicResolver</span>(db));

  <span class="hljs-keyword">let</span> todoList = <span class="hljs-keyword">await</span> <span class="hljs-title class_">TodoList</span>.<span class="hljs-title function_">queryAll</span>(ctx).<span class="hljs-title function_">genOnlyValue</span>(); <span class="hljs-comment">// `genOnlyValue` instead of `gen`</span>
  <span class="hljs-keyword">if</span> (todoList == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">let</span> _;
    [_, todoList] = <span class="hljs-title class_">TodoListMutations</span>.<span class="hljs-title function_">create</span>(ctx, {
      <span class="hljs-attr">name</span>: <span class="hljs-string">"My first list!"</span>,
    }).<span class="hljs-title function_">save</span>();
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(todoList);
}
</code></pre>
<p>Great, we've made a list but we don't have any todos.</p>
<h1 id="defining-an-edge"><a aria-hidden="true" tabindex="-1" href="#defining-an-edge"><span class="icon icon-link"></span></a>Defining an Edge</h1>
<h1 id="walking-a-graph"><a aria-hidden="true" tabindex="-1" href="#walking-a-graph"><span class="icon icon-link"></span></a>Walking a Graph</h1>
<h1 id="reactive-queries"><a aria-hidden="true" tabindex="-1" href="#reactive-queries"><span class="icon icon-link"></span></a>Reactive Queries</h1>
<h1 id="react-integration"><a aria-hidden="true" tabindex="-1" href="#react-integration"><span class="icon icon-link"></span></a>React Integration</h1>
<p>-- vue, solid, svelt</p>
<script src="https://www.googletagmanager.com/gtag/js?id=G-QT6QH0ZJQ4" async></script>
<script src="/ga.js"></script>
<script src="/assets/god-switcher.js"></script>
</section></article></main></body>
</html>
