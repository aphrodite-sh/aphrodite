<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Migrations - Aphrodite</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/tufte.css">
<link rel="stylesheet" href="/main.css">
<link rel="stylesheet" href="/docs/index.css">

<meta name="description" content="Aphrodite provides automatic migration functionality that you may opt into. For controlled migrations, we suggest using automatic migrations until reaching the point of a new release. Once you hit a release, compare the schemas from the new and old…">
<meta name="keywords" content="software, schemas, data">
<meta name="author" content="Matt Wonlaw">
<meta name="copyright" content="© 2022 Matt Wonlaw">
<meta property="og:type" content="article">
<meta property="og:site_name" content="Aphrodite">
<meta property="og:title" content="Migrations">
<meta property="og:description" content="Aphrodite provides automatic migration functionality that you may opt into. For controlled migrations, we suggest using automatic migrations until reaching the point of a new release. Once you hit a release, compare the schemas from the new and old…">
<meta property="og:image" content="https://aphrodite.sh/assets/gods/zeus.png">
<meta property="og:image:alt" content="Zeus">
<meta property="og:image:width" content="266">
<meta property="og:image:height" content="200">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://aphrodite.sh/assets/gods/zeus.png">
<meta name="twitter:image:alt" content="Zeus">
<meta name="twitter:site" content="@tantaman">
<meta name="twitter:label1" content="Reading time">
<meta name="twitter:data1" content="3-5 minutes">
</head>
<body><a href="https://github.com/tantaman/aphrodite" class="github-corner" aria-label="View source on GitHub"><svg width="100" height="100" viewBox="0 0 250 250" style="fill:var(--dress); color:var(--black); position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><aside><div class="center"><a class="home-link" href="/"><div class="god-circle center-block"><div class="god-head god-head-aphrodite"></div></div></a><a class="hamburger"></a></div><ol><li class="indent"><a href="/docs/why">Why Aphrodite</a></li><li class="indent"><a href="/docs/quickstart">Quickstart</a></li><li class="indent"><a href="/docs/schemas">Schemas</a></li><li class="indent"><a href="/docs/models">Models</a></li><li class="indent"><a href="/docs/mutations-and-transactions">Mutating Data</a></li><li class="indent"><a href="/docs/queries">Queries</a></li><li class="indent"><a href="/docs/reactivity">Reactivity</a></li><li class="indent"><a href="/docs/data-sync-p2p">Data Sync &#x26; P2P</a></li><li class="indent"><a href="/docs/permissions">Permissions</a></li><li class="active indent"><a href="/docs/migrations">Migrations</a></li></ol></aside><main><article><h1>Migrations</h1><section>
<nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#automatic-migrations">Automatic Migrations</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#rules-for-safe-automatic-migrations">Rules for Safe Automatic Migrations</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#using-automatic-migrations">Using Automatic Migrations</a></li></ol></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#manual-migrations">Manual Migrations</a></li></ol></nav><p>Aphrodite provides automatic migration functionality that you may opt into. For controlled migrations, we suggest using automatic migrations until reaching the point of a new release. Once you hit a release, compare the schemas from the new and old releases and write a migration script to apply the changes.</p>
<p>If you evolve your schema following a certain set of rules, you can always use automatic migrations and never have to write a manual migration.</p>
<h1 id="automatic-migrations"><a aria-hidden="true" tabindex="-1" href="#automatic-migrations"><span class="icon icon-link"></span></a>Automatic Migrations</h1>
<p>Aphrodites incorporates some features of <a href="https://thrift.apache.org/">Thrift</a> and <a href="https://developers.google.com/protocol-buffers">Google Protocol Buffers</a> to enable automatic migrations. Both of those libraries are made for exchanging messages between services. Services which might have different versions of the message definitions, thus messages must be backwards and forwards compatible. One of the key ways they achieve this compatibility is by associating numbers with field definitions in the message.</p>
<p>The number, not the name, is what identifies the field for the protocol.</p>
<pre><code class="hljs language-protobuf"><span class="hljs-keyword">message </span><span class="hljs-title class_">Person</span> {
  <span class="hljs-keyword">required</span> <span class="hljs-type">string</span> name = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">required</span> <span class="hljs-type">int32</span> id = <span class="hljs-number">2</span>;
  <span class="hljs-keyword">optional</span> <span class="hljs-type">string</span> email = <span class="hljs-number">3</span>;
}
</code></pre>
<p><em>Fig 1: Example message definition from Google Protocol Buffers.</em></p>
<p>Numbers allow the protocol to track fields through renames. A message version that calls a field "a" and another that calls the same numbered field "b" can still interoperate.</p>
<p>In Aphrodite you can (should) number the fields in your schema.</p>
<pre><code class="hljs language-typescript"><span class="hljs-title class_">Todo</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Node</span> {
  <span class="hljs-number">1</span> <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span>&#x3C;<span class="hljs-title class_">Todo</span>>
  <span class="hljs-number">2</span> <span class="hljs-attr">listId</span>: <span class="hljs-variable constant_">ID</span>&#x3C;<span class="hljs-title class_">TodoList</span>>
  <span class="hljs-number">3</span> <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-number">4</span> <span class="hljs-attr">completed</span>: bool
}
</code></pre>
<p><em>Fig 2: Example schema definition, with field numbering, in Aphrodite</em></p>
<p>When doing a migration <code>Aphrodite</code> uses the field numbers to determine what fields were modified (e.g., renamed) vs which were added or removed.</p>
<h2 id="rules-for-safe-automatic-migrations"><a aria-hidden="true" tabindex="-1" href="#rules-for-safe-automatic-migrations"><span class="icon icon-link"></span></a>Rules for Safe Automatic Migrations</h2>
<p>The rules are similar to those in Google Protocol Buffers (<a href="https://developers.google.com/protocol-buffers/docs/proto3#updating">here</a>) but you have some extra freedoms in <code>Aphrodite</code>. The reason there is more freedom is that schema migrations only have to be forwards, not backwards, compatible. I.e., once an update is shipped to a device, there is no more old code left to read the new data.</p>
<p><strong>Rules:</strong></p>
<p><strong>Safe operations:</strong></p>
<ol>
<li>Removing a column is always safe</li>
<li>Adding a nullable column is always safe</li>
<li>Adding a non-nullable column with a default value is always safe</li>
<li>Renaming a column (so long as the column is numbered with the same number in the old and new schema) is always safe</li>
<li>Changing the type of a column to a compatible type is safe
<ol>
<li>Compatible types are any type where type-coercion in your language would do what you expect.</li>
</ol>
</li>
</ol>
<p><strong>Unsafe operations:</strong></p>
<ol>
<li>Changing the type of an existing column to an incompatible type.
<ol>
<li>Incompatible types are any type where the type coercion in the language being used would provided unexpected results. E.g., string -> int in JavaScript.</li>
</ol>
</li>
<li>Adding a new non-nullable column without a default value</li>
<li>Changing the number of an existing field. There should never be a reason to do this.</li>
</ol>
<h2 id="using-automatic-migrations"><a aria-hidden="true" tabindex="-1" href="#using-automatic-migrations"><span class="icon icon-link"></span></a>Using Automatic Migrations</h2>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// use the bootstrap package</span>
<span class="hljs-keyword">import</span> { bootstrap } <span class="hljs-keyword">from</span> <span class="hljs-string">"@aphro/runtime-ts"</span>;

<span class="hljs-comment">// change the below line to import the generated `exports-sql.js` file</span>
<span class="hljs-comment">// this file imports the create table statements.</span>
<span class="hljs-keyword">export</span> sqlFiles <span class="hljs-keyword">from</span> <span class="hljs-string">"./domain/generated/exports-sql.js"</span>;

<span class="hljs-comment">// tell `bootstrap` to create tables and automigrate if those tables exist</span>
<span class="hljs-keyword">await</span> bootstrap.<span class="hljs-title function_">createAutomigrateIfExists</span>(context.<span class="hljs-property">dbResolver</span>, sqlFiles);
</code></pre>
<p>You can see an example in aphrodite-browser-starter here (todo).</p>
<h1 id="manual-migrations"><a aria-hidden="true" tabindex="-1" href="#manual-migrations"><span class="icon icon-link"></span></a>Manual Migrations</h1>
<p><code>Aphrodite</code> does not yet have a framework in which to run manual migrations. You can, however, follow the following process.</p>
<ol>
<li>Diff the generated <code>.sql</code> files between your last release and your current release
<ol>
<li>Only writing migrations between releases cuts down on how often you need to perform them. During development between releases, you can use auto migrations (even if they're unsafe) for improved dev speed.</li>
</ol>
</li>
<li>Write your migration script</li>
<li>Run that script, in a transaction, when your app starts</li>
</ol>
<p>E.g.,</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">await</span> <span class="hljs-title function_">myMigration</span>(ctx);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">myMigration</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> connection = ctx.<span class="hljs-property">dbResolver</span>.<span class="hljs-title function_">engine</span>(<span class="hljs-string">'sqlite'</span>).<span class="hljs-title function_">db</span>(<span class="hljs-string">'my-db'</span>);
  <span class="hljs-keyword">await</span> connection.<span class="hljs-title function_">query</span>(sql<span class="hljs-string">`BEGIN`</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> connection.<span class="hljs-title function_">query</span>(sql<span class="hljs-string">`ALTER TABLE ...`</span>);
    <span class="hljs-keyword">await</span> connection.<span class="hljs-title function_">query</span>(sql<span class="hljs-string">`ALTER TABLE ...`</span>);
    <span class="hljs-keyword">await</span> connection.<span class="hljs-title function_">query</span>(sql<span class="hljs-string">`ALTER TABLE ...`</span>);
    ...
    <span class="hljs-keyword">await</span> connection.<span class="hljs-title function_">query</span>(sql<span class="hljs-string">`COMMIT`</span>);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">await</span> connection.<span class="hljs-title function_">query</span>(sql<span class="hljs-string">`ROLLBACK`</span>);
  }
}
</code></pre>
<script src="https://www.googletagmanager.com/gtag/js?id=G-QT6QH0ZJQ4" async></script>
<script src="/ga.js"></script>
<script src="/assets/god-switcher.js"></script>
</section></article></main></body>
</html>
