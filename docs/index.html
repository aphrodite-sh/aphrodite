<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Overview - Aphrodite</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="index.css">

<meta name="description" content="Aphrodite is a schema layer whose first goal is to make P2P &#x26; Local-First software development as easy as traditional software development. You can think of Aphrodite as an ORM of sorts that is designed for the needs of Local-First applications and P2P da…">
<meta name="keywords" content="software, schemas, data">
<meta name="author" content="Matt Wonlaw">
<meta name="copyright" content="© 2022 Matt Wonlaw">
<meta property="og:type" content="article">
<meta property="og:site_name" content="Aphrodite">
<meta property="og:title" content="Overview">
<meta property="og:description" content="Aphrodite is a schema layer whose first goal is to make P2P &#x26; Local-First software development as easy as traditional software development. You can think of Aphrodite as an ORM of sorts that is designed for the needs of Local-First applications and P2P da…">
<meta property="og:image" content="https://tantaman.com/aphrodite/logos/aphrodite.png">
<meta property="og:image:alt" content="Aphrodite">
<meta property="og:image:width" content="359">
<meta property="og:image:height" content="93">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://tantaman.com/aphrodite/logos/aphrodite.png">
<meta name="twitter:image:alt" content="Aphrodite">
<meta name="twitter:site" content="@tantaman">
<meta name="twitter:label1" content="Reading time">
<meta name="twitter:data1" content="5-7 minutes">
</head>
<body><svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;visibility:hidden;opacity:0;margin:0;padding:0;width:0;height:0"><symbol id="icon-logo-dark"><path d="m501.67 420.7v-269.03c0.13672-40.262-15.824-78.906-44.336-107.34-95.082-95.082-259-27.184-259 107.34 0 358.98 1.8672 236.37-8.2852 299.95l-15.047 94.848c-1.0312 6.4453 3.3555 12.504 9.8008 13.535 6.4414 1.0312 12.5-3.3555 13.531-9.8008 15.285-97.301 14.234-125.54 46.668-163.33v29.867c-6.9258 11.605-10.582 24.867-10.582 38.383 0 13.516 3.6562 26.777 10.582 38.383v54.832c0 6.4453 5.2227 11.668 11.668 11.668 6.4414 0 11.664-5.2227 11.664-11.668v-58.332c0-7.6992-10.617-14-10.617-35s10.617-27.766 10.617-35v-48.883c29.453 38.074 74.832 60.422 122.97 60.551h45.383c15.867 31.266-5.0156 50.285-5.0156 58.332v58.332c0 6.4453 5.2227 11.668 11.664 11.668 6.4453 0 11.668-5.2227 11.668-11.668v-54.949c7.2812-12.117 10.961-26.055 10.609-40.188-0.35156-14.133-4.7188-27.871-12.594-39.613-4.5508-7-6.1836-5.25-61.715-5.25-41.891-0.16406-81.227-20.156-106.05-53.898 44.566-23.332 41.418 3.1484 41.418-53.668 15.371 3.3867 31.293 3.3867 46.664 0v30.102c-0.14453 5.5273 3.6055 10.398 8.9844 11.668 26.746 6.3359 51.004 20.477 69.695 40.625 18.695 20.148 30.984 45.398 35.305 72.539l14.352 94.5c1.0312 6.4453 7.0898 10.832 13.531 9.8008 6.4453-1.0312 10.832-7.0898 9.8008-13.535-16.102-101.5-15.633-105-23.332-125.77zm-120.98-146.65c-25.184 10.207-53.793 7.2227-76.324-7.9609-22.531-15.188-36.039-40.586-36.027-67.758v-35c17.402-1.9766 33.898-8.8086 47.602-19.715 38.148 24.965 75.25 27.648 115.73 21.934v32.781c0.003906 16.266-4.8438 32.156-13.926 45.648-9.0859 13.488-21.988 23.961-37.059 30.07zm15.984 47.832v-30.215c17.406-8.6367 32.074-21.934 42.375-38.414 10.297-16.477 15.824-35.488 15.957-54.922v-46.664c0.035156-3.4023-1.418-6.6445-3.9727-8.8867-2.5547-2.2422-5.9609-3.2578-9.3281-2.7812l-23.918 3.3828h0.003906c-33.902 4.6172-68.266-4.1719-95.785-24.5-15.633-11.668-20.766 21-63.352 21-13.648 0.11719-13.648 10.617-13.648 11.785v46.668-0.003907c0.13281 19.434 5.6602 38.445 15.957 54.922 10.301 16.48 24.969 29.777 42.375 38.414v29.75c-32.586 9.6758-61.207 29.551-81.664 56.699v-226.45c0-45.852 24.457-88.215 64.164-111.14 39.707-22.926 88.629-22.926 128.34 0 39.707 22.926 64.164 65.289 64.164 111.14v226.8c-20.574-26.996-49.16-46.801-81.664-56.582z"></path><path d="m109.08 170.1c-2.5938 5.1406-3.9883 10.805-4.082 16.566-12.504 0-24.059 6.668-30.312 17.5-6.25 10.828-6.25 24.168 0 35 6.2539 10.828 17.809 17.5 30.312 17.5h58.332c3.0938 0 6.0625-1.2305 8.25-3.418s3.418-5.1562 3.418-8.25v-58.332c0.046875-10.512-4.6289-20.488-12.738-27.172-8.1133-6.6836-18.797-9.3711-29.105-7.3164-10.309 2.0586-19.145 8.6367-24.074 17.922zm42.586 63.23c-50.633 0-50.398 1.168-54.949-3.3828h-0.003906c-2.6289-2.5859-3.8828-6.2656-3.3789-9.918 0.50781-3.6562 2.7109-6.8555 5.9492-8.6328 3.6133-1.3984 5.7148-1.3984 17.383-1.3984 3.0938 0 6.0586-1.2305 8.25-3.418 2.1875-2.1875 3.4141-5.1562 3.4141-8.25 0-10.617-1.0508-15.633 3.3828-19.949 3.5352-3.3359 8.6914-4.293 13.184-2.4492 8.6367 3.1484 6.7695 9.6836 6.7695 57.398z"></path><path d="m611.57 62.418c-5.1445-2.5938-10.809-3.9922-16.566-4.0859 0-45.5-70-46.668-70 0v58.336c0 3.0938 1.2305 6.0586 3.418 8.25 2.1875 2.1875 5.1562 3.4141 8.25 3.4141h58.332c10.512 0.050781 20.484-4.6289 27.172-12.738 6.6836-8.1133 9.3672-18.797 7.3125-29.105-2.0547-10.309-8.6328-19.145-17.918-24.07zm-8.2852 39.199c-4.5469 4.5508-4.1992 3.3828-54.949 3.3828 0-47.484-1.9844-54.25 6.7656-57.398h0.003906c4.4922-1.8438 9.6484-0.88672 13.184 2.4492 4.082 4.082 3.3828 7 3.3828 19.949 0 3.0938 1.2266 6.0625 3.4141 8.25 2.1914 2.1875 5.1562 3.418 8.25 3.418 12.832 0 14.117 0 17.148 1.2852l0.003906-0.003906c3.3125 1.7227 5.6016 4.9297 6.1523 8.6211 0.55469 3.6914-0.69141 7.4258-3.3516 10.047z"></path></symbol></svg><header id="header"><a href="/aphrodite" class="logo"><img src="logos/aphrodite.png"><div class="logo-subtext"><span>B</span><span>e</span><span>a</span><span>u</span><span>t</span><span>i</span><span>f</span><span>u</span><span>l</span> <span>S</span><span>c</span><span>h</span><span>e</span><span>m</span><span>a</span><span>s</span></div></a></header><div id="static-container"><div id="before-static"></div><main id="static">
<nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#overview">Overview</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#schema">Schema</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#queries">Queries</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#mutations">Mutations</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#p2p">P2P</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#data-consistency">Data Consistency</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#privacy">Privacy</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#polyglot-storage--server-side">Polyglot Storage &#x26; Server Side</a></li></ol></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#current-implementation">Current Implementation</a></li></ol></nav><p><code>Aphrodite</code> is a schema layer whose first goal is to make <a href="https://en.wikipedia.org/wiki/Peer-to-peer">P2P</a> &#x26; <a href="https://www.inkandswitch.com/local-first/">Local-First</a> software development as easy as traditional software development.</p>
<p>You can think of <code>Aphrodite</code> as an <code>ORM</code> of sorts that is designed for the needs of <a href="https://www.inkandswitch.com/local-first/">Local-First</a> applications and <a href="https://en.wikipedia.org/wiki/Peer-to-peer">P2P</a> data transfer.</p>
<h1 id="overview"><a aria-hidden="true" tabindex="-1" href="#overview"><span class="icon icon-link"></span></a>Overview</h1>
<p>The core of any application is its data and the consistency of that data. As such, everything in <code>Aphrodite</code> begins with a schema. This schema encodes the application's data, its relationships, consistency rules, allowed mutations and privacy.</p>
<h2 id="schema"><a aria-hidden="true" tabindex="-1" href="#schema"><span class="icon icon-link"></span></a>Schema</h2>
<p><code>Aphrodite</code> Schemas are written in a <code>DSL</code>. This <code>DSL</code> describes the <code>nodes</code> and <code>edges</code> that make up the application's data model. The schema can represent graph or relational data models.</p>
<p><strong>Example</strong></p>
<pre><code class="hljs language-js"><span class="hljs-title class_">User</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Node</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span>&#x3C;<span class="hljs-title class_">User</span>>
  <span class="hljs-attr">name</span>: <span class="hljs-title class_">NaturalLanguage</span>
  <span class="hljs-attr">created</span>: <span class="hljs-title class_">Timestamp</span>
  <span class="hljs-attr">modified</span>: <span class="hljs-title class_">Timestamp</span>
} &#x26; <span class="hljs-title class_">OutboundEdges</span> {
  <span class="hljs-attr">todos</span>: <span class="hljs-title class_">Edge</span>&#x3C;<span class="hljs-title class_">Todo</span>.<span class="hljs-property">ownerId</span>>
}

<span class="hljs-title class_">Todo</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Node</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span>&#x3C;<span class="hljs-title class_">Todo</span>>
  <span class="hljs-attr">text</span>: <span class="hljs-title class_">NaturalLanguage</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-title class_">Timestamp</span> | <span class="hljs-literal">null</span>
  <span class="hljs-attr">created</span>: <span class="hljs-title class_">Timestamp</span>
  <span class="hljs-attr">modified</span>: <span class="hljs-title class_">Timestamp</span>
  <span class="hljs-attr">ownerId</span>: <span class="hljs-variable constant_">ID</span>&#x3C;<span class="hljs-title class_">User</span>>
} &#x26; <span class="hljs-title class_">OutboundEdges</span> {
  <span class="hljs-attr">owner</span>: <span class="hljs-title class_">Edge</span>&#x3C;ownerId>
}
</code></pre>
<p>From the schema definition, <code>Aphrodite</code> generates <code>TypeScript</code> (and eventually other target languages) classes to interact with your data.</p>
<h2 id="queries"><a aria-hidden="true" tabindex="-1" href="#queries"><span class="icon icon-link"></span></a>Queries</h2>
<p>The main way of interacting with your data after defining a schema is through queries. Queries allow you to load, find and join your data in arbitrary ways.</p>
<p>To support local first development, all queries against your data can also be made reactive. Also to support local first, all components that view a given piece of data will always see the latest version of that data unless they explicitly and overtly decide not to.</p>
<p><strong>Load and Query</strong></p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">load</span>(<span class="hljs-string">`user-id`</span>);
<span class="hljs-keyword">const</span> todos = <span class="hljs-keyword">await</span> user.<span class="hljs-title function_">queryTodos</span>().<span class="hljs-title function_">gen</span>();

<span class="hljs-keyword">const</span> liveCompletedTodos = user.<span class="hljs-title function_">queryTodos</span>().<span class="hljs-title function_">whereCompleted</span>(P.<span class="hljs-title function_">notEqual</span>(<span class="hljs-literal">null</span>)).<span class="hljs-title function_">live</span>();

liveCompletedTodos.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">completed</span>) =></span> ...);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">{user}: {user: User}</span>) {
  <span class="hljs-keyword">const</span> todos = <span class="hljs-title function_">useQuery</span>(<span class="hljs-function">() =></span> user.<span class="hljs-title function_">queryTodos</span>().<span class="hljs-title function_">live</span>());
  <span class="hljs-keyword">return</span> todos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =></span> <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Todo</span> <span class="hljs-attr">todo</span>=<span class="hljs-string">{todo}</span> /></span></span>);
}
</code></pre>
<h2 id="mutations"><a aria-hidden="true" tabindex="-1" href="#mutations"><span class="icon icon-link"></span></a>Mutations</h2>
<p>Before you can query any data you need to create it. <code>Aphrodite</code> supports mutation primitives to allow you to do this in a safe and declarative way.</p>
<p>To ensure your app never sees transient state, <code>Aphrodite</code> has concepts of <code>mutators</code>, <code>changesets</code> and <code>transactions</code>. These allow you to describe a mutation in full and then commit the mutation all at once. Mutations can be declared on the schema for convenience to allow programmatic discovery of operations against your data (inspired by <a href="https://blockprotocol.org/">Block Protocl</a> and my prior work at @meta on a protocol for integrations (<a href="https://github.com/tantaman/tantaman.github.io/blob/master/_drafts/2022-01-26-protocol-for-integrations.markdown">draft post</a>).</p>
<p><strong>Declare Mutations</strong></p>
<pre><code class="hljs language-js"><span class="hljs-title class_">Todo</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Node</span> {
  ...
} &#x26; <span class="hljs-title class_">OutboundEdges</span> {
  ...
} &#x26; <span class="hljs-title class_">Mutations</span> {
  create {
    text
  }
  complete
  uncomplete
}
</code></pre>
<p><strong>Transactions</strong></p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> mutation = <span class="hljs-title class_">TodoMutations</span>.<span class="hljs-title function_">create</span>(viewer, <span class="hljs-string">'My first todo which is already done!'</span>).<span class="hljs-title function_">complete</span>();

<span class="hljs-comment">// We can either commit the mutation now</span>
<span class="hljs-keyword">await</span> mutation.<span class="hljs-title function_">save</span>();

<span class="hljs-comment">// Or we can batch it with other mutations that should be commited all at once</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">commit</span>(mutation.<span class="hljs-title function_">toChangeset</span>(), <span class="hljs-title class_">TodoMutation</span>.<span class="hljs-title function_">create</span>(viewer, <span class="hljs-string">'My second todo!'</span>).<span class="hljs-title function_">toChangeset</span>());
</code></pre>
<p>You can collect as many mutations to your application's state as you want before finally committing them all together.</p>
<h2 id="p2p"><a aria-hidden="true" tabindex="-1" href="#p2p"><span class="icon icon-link"></span></a>P2P</h2>
<p>To support syncing, you can opt your data models into <code>P2P</code> replication and declare what <a href="https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type">conflict free replicated data type</a> (CRDTs) to use under the hood to merge state across peers.</p>
<p><strong>Example Replication Declarations</strong></p>
<pre><code class="hljs language-js"><span class="hljs-title class_">Todo</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Node</span> {
  ...
} &#x26; <span class="hljs-title class_">Replication</span> {
  <span class="hljs-title class_">ColumnLevel</span> {
    last-write-wins
  }
  <span class="hljs-title class_">Clock</span> {
    <span class="hljs-title class_">Logical</span>
  }
}

-or-

<span class="hljs-title class_">Todo</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Node</span> {
  ...
} &#x26; <span class="hljs-title class_">Replication</span> {
  <span class="hljs-title class_">InstanceLevel</span> {
    last-write-wins
  }
  <span class="hljs-title class_">Clock</span> {
    <span class="hljs-title class_">HybridLogical</span> {
      <span class="hljs-attr">resolution</span>: 60s
    }
  }
}
</code></pre>
<p><strong>Note</strong> -- P2P syncing via CRDTs do not support transactions fully. You can create and commit a transaction on one client but, due to the nature of CRDTs, other clients may not accept the full contents of the transaction. So how do we ensure data consistency in the face of this?</p>
<h2 id="data-consistency"><a aria-hidden="true" tabindex="-1" href="#data-consistency"><span class="icon icon-link"></span></a>Data Consistency</h2>
<p>Given we cannot support transactions across instances when replicating to peers, how can we keep our application data consistent?</p>
<p>Developers can define integrity constraints on their schemas. When a replicated update is received that violates the constraint, a new state update is added that rolls back the update. This feature is still in the research phase to understand what constraints and rollbacks can be supported in a p2p environment without causing state loops amongst peers.</p>
<p>The data consistency ideas are part inspired by <a href="https://hal.inria.fr/hal-02983557/document">Conflict Free Replicated Relations</a> and the internal <code>Ent Integrity</code> project at <a href="https://engineering.fb.com/">Meta</a>.</p>
<h2 id="privacy"><a aria-hidden="true" tabindex="-1" href="#privacy"><span class="icon icon-link"></span></a>Privacy</h2>
<p>You may have noticed references to <code>owner</code> and <code>viewer</code> in the example code. This is because <code>Aphrodite</code> supports privacy on data even though it targets local first development.</p>
<p>Imagine you have a local first app but your users want to be able to share parts of their local data with others. Your user's data shouldn't be replicated to just anyone. There need to be privacy controls in place to determine what users receive what updates.</p>
<p><code>Aphrodite</code> allows you to declare these rules on the schema itself or, when they're more complicated, within <code>TypeScript</code>.</p>
<p>The rules are run any time data is loaded and any time is it being replicated across the network to a peer. Mutation rules can also be enable to allow read access but not write or vice-versa.</p>
<pre><code class="hljs language-js"><span class="hljs-title class_">Todo</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Node</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span>&#x3C;<span class="hljs-title class_">Todo</span>>
  <span class="hljs-attr">text</span>: <span class="hljs-title class_">NaturalLanguage</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-title class_">Timestamp</span> | <span class="hljs-literal">null</span>
  <span class="hljs-attr">ownerId</span>: <span class="hljs-variable constant_">ID</span>&#x3C;<span class="hljs-title class_">User</span>>
} &#x26; <span class="hljs-title class_">Edges</span> {
  <span class="hljs-attr">sharedWith</span>: <span class="hljs-title class_">JunctionEdge</span>&#x3C;<span class="hljs-title class_">Todo</span>, <span class="hljs-title class_">User</span>>
} &#x26; <span class="hljs-title class_">ReadPrivacy</span> {
  <span class="hljs-title class_">AllowIf</span>(<span class="hljs-function">(<span class="hljs-params">viewer, todo</span>) =></span> todo.<span class="hljs-property">ownerId</span> === viewer.<span class="hljs-property">id</span>),
  <span class="hljs-title class_">AllowIf</span>(<span class="hljs-function">(<span class="hljs-params">viewer, todo</span>) =></span> todo.<span class="hljs-title function_">querySharedWith</span>().<span class="hljs-title function_">whereId</span>(P.<span class="hljs-title function_">equals</span>(viewer.<span class="hljs-property">id</span>)).<span class="hljs-title function_">exists</span>())
  <span class="hljs-title class_">AlwaysDeny</span>
}
</code></pre>
<h2 id="polyglot-storage--server-side"><a aria-hidden="true" tabindex="-1" href="#polyglot-storage--server-side"><span class="icon icon-link"></span></a>Polyglot Storage &#x26; Server Side</h2>
<p><code>Aphrodite</code> isn't constrainted to local first software. It is a fully featured <code>ORM</code> for backends as well and allows traditional client-server development in addition to p2p applications.</p>
<p><code>Aphrodite</code> will also support joins across different storage layers. E.g., traversing edges between <code>SQL</code>, <code>Redis</code>, <code>Neo4j</code> rows. This is done via <a href="https://gist.github.com/tantaman/bd928ef93619e73365b07899da282996#aside---traversing-across-storage-backends">ChunkIterables</a> and <a href="https://github.com/tantaman/aphrodite/blob/main/packages/query-runtime-ts/src/HopPlan.ts">HopPlans</a>.</p>
<h1 id="current-implementation"><a aria-hidden="true" tabindex="-1" href="#current-implementation"><span class="icon icon-link"></span></a>Current Implementation</h1>
<p><code>Aphrodite</code> is under active development here: <a href="https://github.com/tantaman/aphrodite">https://github.com/tantaman/aphrodite</a></p>
<p>It <strong>is not</strong> ready for release.</p>
<p>Integration tests to show the various described use cases are being built out here: <a href="https://github.com/tantaman/aphrodite/blob/main/packages/integration-tests-ts/src/__tests__/mutators.test.ts">https://github.com/tantaman/aphrodite/blob/main/packages/integration-tests-ts/src/<strong>tests</strong>/mutators.test.ts</a> (and up a dir)</p>
<script src="https://www.googletagmanager.com/gtag/js?id=UA-177900110-1" async></script>
<script src="/ga.js"></script>
</main><div id="after-static"></div></div><footer id="footer"></footer></body>
</html>
